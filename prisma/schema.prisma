// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// ğŸ‘¤ ì‚¬ìš©ì (User)
// ---------------------------------------------------------
model User {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  email    String  @unique
  password String
  name     String?

  // ê´€ê³„ ì„¤ì •
  bankAccounts       BankAccount[]
  investmentAccounts InvestmentAccount[]
  cards              Card[]
  categories         Category[]
  transactions       MoneyTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------------------------------------
// ğŸ’³ ì¹´ë“œ (Card) - NEW!
// ---------------------------------------------------------
model Card {
  id   String   @id @default(auto()) @map("_id") @db.ObjectId
  name String // ì˜ˆ: í˜„ëŒ€ì¹´ë“œ M3, ì¹´ì¹´ì˜¤ ì²´í¬
  type CardType // CREDIT(ì‹ ìš©), CHECK(ì²´í¬)

  currentBalance Float @default(0)

  limit       Float? // ì‹ ìš© í•œë„ (ì„ íƒ)
  paymentDate Int? // ê²°ì œì¼ (ì˜ˆ: 14, 25 ë“±)

  // ì²´í¬ì¹´ë“œì¸ ê²½ìš° ì—°ê²°ëœ ê³„ì¢Œ (ì‹ ìš©ì¹´ë“œë„ ê²°ì œ ê³„ì¢Œë¡œ ì—°ê²° ê°€ëŠ¥)
  linkedBankAccountId String?      @db.ObjectId
  linkedBankAccount   BankAccount? @relation(fields: [linkedBankAccountId], references: [id])

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // ì´ ì¹´ë“œë¡œ ê²°ì œí•œ ë‚´ì—­ë“¤
  transactions MoneyTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CardType {
  CREDIT // ì‹ ìš©ì¹´ë“œ (ë¶€ì±„ ë°œìƒ)
  CHECK // ì²´í¬ì¹´ë“œ (ì¦‰ì‹œ ì¶œê¸ˆ)
}

// ---------------------------------------------------------
// ğŸ¦ ì€í–‰/í˜„ê¸ˆ ê³„ì¢Œ (BankAccount)
// ---------------------------------------------------------
model BankAccount {
  id   String   @id @default(auto()) @map("_id") @db.ObjectId
  name String // ì˜ˆ: ì›”ê¸‰í†µì¥, ë¹„ìƒê¸ˆì§€ê°‘
  type BankType // CHECKING(ì…ì¶œê¸ˆ), SAVINGS(ì˜ˆì ê¸ˆ), CASH(í˜„ê¸ˆ)

  currentBalance Float @default(0) // í˜„ì¬ ì”ì•¡

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // ê´€ê³„
  transactions MoneyTransaction[] // ì´ ê³„ì¢Œì˜ ì…ì¶œê¸ˆ ë‚´ì—­
  linkedCards  Card[] // ì´ ê³„ì¢Œì— ì—°ê²°ëœ ì¹´ë“œë“¤

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum BankType {
  CHECKING // ìˆ˜ì‹œ ì…ì¶œê¸ˆ
  SAVINGS // ì˜ˆì ê¸ˆ (ì €ì¶•ì„±)
  CASH // í˜„ê¸ˆ ì§€ê°‘
}

// ---------------------------------------------------------
// ğŸ’¸ ê°€ê³„ë¶€ ê±°ë˜ ë‚´ì—­ (MoneyTransaction)
// ---------------------------------------------------------
// ì€í–‰ ê³„ì¢Œì˜ ì…ì¶œê¸ˆ OR ì‹ ìš©ì¹´ë“œ ì§€ì¶œ ë‚´ì—­ì„ í†µí•© ê´€ë¦¬
model MoneyTransaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  type        TxType // INCOME, EXPENSE, TRANSFER
  amount      Float
  date        DateTime
  description String?

  bankAccountId String?      @db.ObjectId
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  cardId        String?      @db.ObjectId
  card          Card?        @relation(fields: [cardId], references: [id])
  categoryId    String?      @db.ObjectId
  category      Category?    @relation(fields: [categoryId], references: [id])
  user          User         @relation(fields: [userId], references: [id])
  userId        String       @db.ObjectId

  isTransfer Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TxType {
  INCOME // ìˆ˜ì…
  EXPENSE // ì§€ì¶œ
  TRANSFER // ì´ì²´ (ë‚´ ê³„ì¢Œê°„ ì´ë™)
}

// ---------------------------------------------------------
// ğŸ· ì¹´í…Œê³ ë¦¬ (Category)
// ---------------------------------------------------------
model Category {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  name String
  type TxType // INCOME, EXPENSE

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  transactions MoneyTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------------------------------------
// ğŸ“ˆ íˆ¬ì ê³„ì¢Œ (InvestmentAccount)
// ---------------------------------------------------------
model InvestmentAccount {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  name       String // ì˜ˆ: í‚¤ì›€ì¦ê¶Œ, ì—…ë¹„íŠ¸
  detailType InvestType // STOCK, COIN, REAL_ESTATE

  investedAmount     Float @default(0)
  cumulativeDividend Float @default(0)
  currentValuation   Float @default(0)

  accountOpenDate DateTime @default(now())

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  investmentSnapshots InvestmentSnapshot[]
  investmentLogs      InvestmentLog[]
}

enum InvestType {
  STOCK // ì£¼ì‹
  COIN // ì½”ì¸
  REAL_ESTATE // ë¶€ë™ì‚°
  BOND // ì±„ê¶Œ
  PENSION_SAVINGS // ì—°ê¸ˆì €ì¶•
  IRP // IRP (í‡´ì§ì—°ê¸ˆ)
  ISA // ISA (ê°œì¸ì¢…í•©ìì‚°ê´€ë¦¬ê³„ì¢Œ)
  ETC // ê¸°íƒ€
}

// ì¼ë³„ í‰ê°€ê¸ˆ ê¸°ë¡ (ì°¨íŠ¸ìš© ë°ì´í„°)
model InvestmentSnapshot {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  date           DateTime
  totalValue     Float // ê·¸ ë‚ ì˜ í‰ê°€ê¸ˆ
  investedAmount Float // ê·¸ ë‚  ê¸°ì¤€ ì›ê¸ˆ (ìˆ˜ìµë¥  ê³„ì‚°ìš©)

  investmentAccountId String            @db.ObjectId
  investmentAccount   InvestmentAccount @relation(fields: [investmentAccountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([investmentAccountId, date]) // ê°™ì€ ë‚ ì§œ ì¤‘ë³µ ë°©ì§€
}

// íˆ¬ì ì›ê¸ˆ ë³€ë™ ê¸°ë¡ (ì˜ˆìˆ˜ê¸ˆ ì…ì¶œê¸ˆ)
model InvestmentLog {
  id     String        @id @default(auto()) @map("_id") @db.ObjectId
  type   InvestLogType
  amount Float
  date   DateTime
  note   String?

  investmentAccountId String            @db.ObjectId
  investmentAccount   InvestmentAccount @relation(fields: [investmentAccountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvestLogType {
  DEPOSIT // íˆ¬ìê¸ˆ íˆ¬ì… (ì‹œë“œ ì¦ê°€)
  WITHDRAW // íˆ¬ìê¸ˆ íšŒìˆ˜ (ì‹œë“œ ê°ì†Œ)
  DIVIDEND // ë°°ë‹¹ê¸ˆ ì¶”ê°€
}
